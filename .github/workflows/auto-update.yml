name: Auto Update Meta

on:
  schedule:
    # Her 5 saatte bir calisir (00:00, 05:00, 10:00, 15:00, 20:00 UTC)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Manuel tetikleme imkani
  push:
    branches:
      - main
    paths:
      - 'meta/**'
      - 'update.sh'
      - '.github/workflows/auto-update.yml'

jobs:
  Update-Meta:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix (flakes)
        uses: DeterminateSystems/nix-installer-action@v13
    
      - name: Restore cache
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            caches/forge_cache
            caches/http_cache
          key: meta-cache-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            meta-cache-${{ runner.os }}-
    
      - name: Prepare caches
        run: |
          mkdir -p caches/forge_cache
          mkdir -p caches/http_cache
    
      - name: Checkout upstream (uses secret token)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: Project-Tick/meta-upstream
          path: upstream
          token: ${{ secrets.META_BOT_TOKEN }}
    
      - name: Checkout launcher (uses secret token)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: Project-Tick/meta-launcher
          path: launcher
          token: ${{ secrets.META_BOT_TOKEN }}

      - name: Build flake package (sanity check)
        run: nix build .#blockgame-meta
    
      - name: Configure environment
        run: |
          echo "META_CACHE_DIR=${{ github.workspace }}/caches" >> $GITHUB_ENV
          echo "META_UPSTREAM_DIR=${{ github.workspace }}/upstream" >> $GITHUB_ENV
          echo "META_LAUNCHER_DIR=${{ github.workspace }}/launcher" >> $GITHUB_ENV
          echo "DEPLOY_TO_GIT=true" >> $GITHUB_ENV
          echo "GIT_AUTHOR_NAME=GitHub Actions Bot" >> $GITHUB_ENV
          echo "GIT_AUTHOR_EMAIL=github-actions[bot]@users.noreply.github.com" >> $GITHUB_ENV
          echo "GIT_COMMITTER_NAME=GitHub Actions Bot" >> $GITHUB_ENV
          echo "GIT_COMMITTER_EMAIL=github-actions[bot]@users.noreply.github.com" >> $GITHUB_ENV
    
      - name: Run update scripts
        run: |
          nix develop .# --command bash -lc "
            python -m meta.run.update_mojang
            python -m meta.run.update_forge
            python -m meta.run.update_neoforge
            python -m meta.run.update_fabric
            python -m meta.run.update_quilt
            python -m meta.run.update_liteloader
            python -m meta.run.update_java
          "
    
      - name: Generate meta files
        run: |
          nix develop .# --command bash -lc "
            python -m meta.run.generate_mojang
            python -m meta.run.generate_forge
            python -m meta.run.generate_neoforge
            python -m meta.run.generate_fabric
            python -m meta.run.generate_quilt
            python -m meta.run.generate_liteloader
            python -m meta.run.generate_java
            python -m meta.run.index
          "
    
      - name: Commit and push changes
        run: |
          cd upstream
          git add -A
          if ! git diff --cached --exit-code; then
            currentDate=$(date -I)
            currentTime=$(date +"%H:%M:%S")
            git commit -m "Update Date ${currentDate} Time ${currentTime}"
            git push
          else
            echo "No changes to commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Save cache
        uses: actions/cache/save@v4
        if: always() && steps.restore-cache.outputs.cache-hit != 'true'
        with:
          path: |
            caches/forge_cache
            caches/http_cache
          key: ${{ steps.restore-cache.outputs.cache-primary-key }}
