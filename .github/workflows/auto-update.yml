name: Auto Update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

concurrency:
  group: auto-update
  cancel-in-progress: true

permissions:
  contents: write

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  STATE_DIRECTORY: /tmp/meta-state
  CACHE_DIRECTORY: /tmp/meta-cache
  META_UPSTREAM_URL: ${{ secrets.META_UPSTREAM_URL }}
  META_LAUNCHER_URL: ${{ secrets.META_LAUNCHER_URL }}

jobs:
  update:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH keys for clones/pushes
        env:
          DEPLOY_SSH_KEY_UPSTREAM: ${{ secrets.DEPLOY_SSH_KEY_UPSTREAM }}
          DEPLOY_SSH_KEY_LAUNCHER: ${{ secrets.DEPLOY_SSH_KEY_LAUNCHER }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          eval "$(ssh-agent -s)" >/dev/null

          add_key() {
            local key_content="$1"
            local key_file="$2"
            if [ -n "$key_content" ]; then
              install -m 600 /dev/null "$key_file"
              printf '%s\n' "$key_content" > "$key_file"
              ssh-add "$key_file"
            fi
          }

          add_key "$DEPLOY_SSH_KEY_UPSTREAM" ~/.ssh/deploy_key_upstream
          add_key "$DEPLOY_SSH_KEY_LAUNCHER" ~/.ssh/deploy_key_launcher

          echo "GIT_SSH_COMMAND=ssh -o StrictHostKeyChecking=accept-new" >> "$GITHUB_ENV"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install .

      - name: Prepare state and cache directories
        run: |
          mkdir -p "$STATE_DIRECTORY" "$CACHE_DIRECTORY"

      - name: Make scripts executable
        run: chmod +x init.sh update.sh

      - name: Initialize upstream and launcher repositories
        run: ./init.sh

      - name: Run updater
        run: ./update.sh
